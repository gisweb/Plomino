<tal:block tal:define="plomino_view python:here;
    b plomino_view/ActionBarPosition|nothing;
    hasReadPermission python:test(
        here.hasReadPermission(here)==True and
        here.hasReadPermission(here.getParentDatabase())==True)">
    <tal:hasReadPermission condition="python:test(hasReadPermission==True)">
        <tal:view_actions
            define="owner python:plomino_view"
            condition="python:b and plomino_view.ActionBarPosition in ['TOP', 'BOTH']">
            <span metal:use-macro="here/ActionBar/macros/ViewActionBar">
            display view actions </span>
        </tal:view_actions>
    </tal:hasReadPermission>
    <tal:dynamic_widget tal:define="
        hideCheckboxes plomino_view/HideCheckboxes|nothing;
        hasRemovePermission python:here.hasRemovePermission(here)==True;
        requiredwidget here/REQUEST/widget|nothing;
        viewwidget python:requiredwidget == 'BASIC' and requiredwidget or here.getWidget();
        ajaxsource python: '\'../vista/tojson?sSearch=%s\'' % (options.get('sSearch') or '')"
        tal:condition="python:viewwidget == 'DYNAMICTABLE'">
                        <script type="text/javascript" charset="utf-8"
                            tal:define="params here/DynamicTableParameters;
                                        iscategorized python:getattr(here, 'Categorized', False);
                                        categorized python:iscategorized and 'true' or 'false';
                                        fixedsorting python:iscategorized and '\'aaSortingFixed\': [[1, \'asc\']],' or '';
                                        fixedcol1size python:iscategorized and '{ \'aTargets\': [1], \'sWidth\': \'0\' },' or '';
                                        display_checkboxes python:test(hasRemovePermission and not(hideCheckboxes), 'true', 'false')"
                            tal:content="structure string:
                                        var oDynamicTable;
                                        jQuery(document).ready(function() {
                                                oDynamicTable = jQuery('#dynamictable').dataTable( {
                                                    'aaSorting': [],
                                                    'bJQueryUI': true,
                                                    'bProcessing': true,
                                                    'sAjaxSource': ${ajaxsource},
                                                    'bServerSide': true,
                                                    ${params},
                                                    'aoColumnDefs': [
                                                        { 'aTargets': ['_all'],
                                                        'bUseRendered': false,
                                                        'fnRender': dynamicview_generate_cells_content($display_checkboxes)
                                                        },
                                                        ${fixedcol1size}
                                                        { 'aTargets': [0], 'bSearchable': false, 'bSortable': false, 'sWidth': '0' }
                                                    ],
                                                    ${fixedsorting}
                                                    'fnDrawCallback': function() {
                                                        this.fnSetFilteringLimit(1);
                                                        if (${categorized}) {
                                                            dynamicview_categorize('dynamictable');
                                                        }
                                                    },
                                                    // Move to field settings?
                                                    // 'fnFooterCallback': generateTableFooter,
                                                    'oLanguage': {
                                                        'sUrl': '@@collective.js.datatables.translation'
                                                    }
                                                });
                                                var tableNodes = oDynamicTable.fnGetNodes();
                                                jQuery('td > input:checkbox', tableNodes).change(function() {
                                                    jQuery(this).closest('tr').toggleClass('row_selected');
                                                });
                                            });">
                        </script>

                        <table class="display" id="dynamictable" tal:define="columns here/getColumns">
                            <thead>
                                <tr>
                                    <th></th>
                                    <tal:column_titles repeat="column columns">
                                        <th tal:condition="not: column/HiddenColumn|nothing"
                                            tal:content="column/Title"
                                            tal:attributes="class python:getattr(column, 'DisplaySum') and 'displaysum' or ''"></th>
                                    </tal:column_titles>
                                </tr>
                            </thead>
                            <tfoot>
                                <tal:sums metal:use-macro="here/view_macros/macros/SumsMacro">sums</tal:sums>
                            </tfoot>
                            <tbody></tbody>
                        </table>

                        <p style="clear: both;" class="discreet">
                            <a href="?widget=BASIC" i18n:translate="plominoview_viewstatictable">View as static table</a>
                        </p>
    </tal:dynamic_widget>
</tal:block>